-- Kiểm tra quyền truy cập script
local lp = game.Players.LocalPlayer
local allowedUser = "phevatvaiz"

if lp.Name ~= allowedUser then
    local success, result = pcall(function()
        return lp:IsFriendsWith(game.Players:GetUserIdFromNameAsync(allowedUser))
    end)

    if not success or not result then
        lp:Kick("Chỉ có chủ nhân của script này hoặc bạn bè của ngài ấy mới có quyền dùng script này")
        return
    end
end

-- Tải OrionLib
local success, OrionLib = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()
end)

if not success then
    warn("Không thể tải OrionLib.")
    return
end

-- Khởi tạo người chơi và nhân vật
local char = lp.Character or lp.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")

-- Trạng thái
local autoHeal = false
local speedEnabled = false
local invisibilityEnabled = false
local alreadyInvisible = false

-- Hàm cập nhật nhân vật khi reset
local function updateCharacter(newChar)
    char = newChar
    hum = char:WaitForChild("Humanoid")
    hrp = char:WaitForChild("HumanoidRootPart")
    alreadyInvisible = false
end

-- GUI OrionLib
local Window = OrionLib:MakeWindow({
    Name = "TSB-hub | By: Minh",
    HidePremium = false,
    SaveConfig = false,
    ConfigFolder = "TSBHub"
})

local MainTab = Window:MakeTab({
    Name = "Chức Năng",
    Icon = "rbxassetid://4483345998",
    PremiumOnly = false
})

MainTab:AddToggle({
    Name = "Tự Hồi Máu",
    Default = false,
    Callback = function(state)
        autoHeal = state
    end
})

MainTab:AddToggle({
    Name = "Tăng Tốc Độ",
    Default = false,
    Callback = function(state)
        speedEnabled = state
    end
})

MainTab:AddToggle({
    Name = "Tàng Hình",
    Default = false,
    Callback = function(state)
        invisibilityEnabled = state
    end
})

-- Theo dõi khi người chơi reset
lp.CharacterAdded:Connect(updateCharacter)

-- Vòng lặp tính năng
game:GetService("RunService").Heartbeat:Connect(function()
    if not char or not hum or not hrp then return end

    -- Hồi máu
    if autoHeal and hum.Health < hum.MaxHealth then
        hum.Health = hum.MaxHealth
    end

    -- Tốc độ: Luôn là 100 nếu bật
    if speedEnabled and hum.WalkSpeed ~= 100 then
        hum.WalkSpeed = 100
    end

    -- Tàng hình hoàn hảo
    if invisibilityEnabled and not alreadyInvisible then
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.LocalTransparencyModifier = 1
                part.Transparency = 1
                if part:FindFirstChildOfClass("Decal") then
                    part:FindFirstChildOfClass("Decal").Transparency = 1
                end
            end
        end
        local head = char:FindFirstChild("Head")
        if head then
            for _, gui in ipairs(head:GetChildren()) do
                if gui:IsA("BillboardGui") then
                    gui.Enabled = false
                end
            end
        end
        alreadyInvisible = true
    elseif not invisibilityEnabled and alreadyInvisible then
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.LocalTransparencyModifier = 0
                part.Transparency = 0
                if part:FindFirstChildOfClass("Decal") then
                    part:FindFirstChildOfClass("Decal").Transparency = 0
                end
            end
        end
        local head = char:FindFirstChild("Head")
        if head then
            for _, gui in ipairs(head:GetChildren()) do
                if gui:IsA("BillboardGui") then
                    gui.Enabled = true
                end
            end
        end
        alreadyInvisible = false
    end
end)

-- Khởi động GUI
OrionLib:Init()
